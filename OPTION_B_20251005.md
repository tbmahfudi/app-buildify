# Option B Implementation - Metadata-Driven System

## ğŸ‰ What's New in Option B

Building on Option A's foundation (Auth & Org CRUD), Option B adds:

### âœ… 1. Metadata Service
**Purpose**: Store and retrieve entity schemas dynamically

**Models**: `EntityMetadata`
- Entity configuration (name, display, icon)
- Table configuration (columns, filters, sorting)
- Form configuration (fields, validation, widgets)
- RBAC permissions per entity
- Version control

**Endpoints**:
- `GET /api/metadata/entities` - List all entities
- `GET /api/metadata/entities/{entity}` - Get entity metadata
- `POST /api/metadata/entities` - Create metadata (admin)
- `PUT /api/metadata/entities/{entity}` - Update metadata (admin)
- `DELETE /api/metadata/entities/{entity}` - Soft delete (admin)

### âœ… 2. Generic CRUD Endpoints
**Purpose**: Universal data operations for any entity

**Endpoints**:
- `POST /api/data/{entity}/list` - Search/list with filters, sort, pagination
- `GET /api/data/{entity}/{id}` - Get single record
- `POST /api/data/{entity}` - Create record
- `PUT /api/data/{entity}/{id}` - Update record
- `DELETE /api/data/{entity}/{id}` - Delete record
- `POST /api/data/{entity}/bulk` - Bulk operations

**Features**:
- Dynamic entity resolution
- Filter operators: eq, ne, gt, gte, lt, lte, like, in
- Multi-field sorting
- Global search
- Scope filtering (tenant isolation)
- Automatic audit logging

### âœ… 3. Audit System
**Purpose**: Track all operations for compliance

**Models**: `AuditLog`
- Who (user_id, email, tenant)
- What (action, entity_type, entity_id)
- When (created_at)
- Details (before/after diff, metadata)
- Context (IP, user agent, request ID)
- Result (status, error_message)

**Endpoints**:
- `POST /api/audit/list` - List audit logs with filters
- `GET /api/audit/{log_id}` - Get specific log
- `GET /api/audit/stats/summary` - Audit statistics (admin)

**Auto-Logged Actions**:
- CREATE, UPDATE, DELETE on all entities
- LOGIN, LOGOUT, REFRESH
- CREATE_METADATA, UPDATE_METADATA, DELETE_METADATA
- UPDATE_USER_SETTINGS, UPDATE_TENANT_SETTINGS

### âœ… 4. Settings & Preferences
**Purpose**: User and tenant customization

**Models**: `UserSettings`, `TenantSettings`

**User Settings**:
- Theme (light/dark)
- Language
- Timezone
- Density (compact/normal/comfortable)
- Custom preferences (JSON)

**Tenant Settings**:
- Branding (name, logo, colors)
- Theme configuration (CSS variables)
- Feature flags
- Misc settings (JSON)

**Endpoints**:
- `GET /api/settings/user` - Get user settings
- `PUT /api/settings/user` - Update user settings
- `GET /api/settings/tenant` - Get tenant settings
- `PUT /api/settings/tenant` - Update tenant settings (admin)

## ğŸ“Š Database Schema Changes

### New Tables

1. **entity_metadata**
   - Stores metadata definitions
   - Columns, fields, permissions
   - Version control

2. **audit_logs**
   - Complete audit trail
   - Indexed for fast queries
   - Stores diff JSON

3. **user_settings**
   - Per-user preferences
   - Unique constraint on user_id

4. **tenant_settings**
   - Tenant-wide configuration
   - Branding and features

## ğŸ”§ Architecture Improvements

### Entity Registry
```python
ENTITY_REGISTRY = {
    "companies": Company,
    "branches": Branch,
    "departments": Department,
    "users": User
}
```

Easily extensible - just add new entities to the registry!

### Audit Middleware
All CUD operations are automatically audited with:
- User context
- Before/after state
- IP address and user agent
- Request ID for tracing

### Dynamic Query Building
- Filters applied dynamically
- Multi-field sorting
- Pagination
- Tenant scoping

## ğŸš€ How to Use

### 1. Run Migrations

**PostgreSQL:**
```bash
cd backend
alembic upgrade pg_b2c3d4e5f6a7
```

**MySQL:**
```bash
alembic upgrade mysql_a7f6e5d4c3b2
```

### 2. Seed Metadata

```bash
python -m app.seeds.seed_metadata
```

This creates metadata for companies, branches, and departments.

### 3. Test Generic CRUD

```bash
# Get metadata
curl http://localhost:8000/api/metadata/entities/companies \
  -H "Authorization: Bearer $TOKEN"

# List companies via generic endpoint
curl -X POST http://localhost:8000/api/data/companies/list \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "entity": "companies",
    "page": 1,
    "page_size": 10,
    "filters": [],
    "sort": [["name", "asc"]]
  }'

# Create via generic endpoint
curl -X POST http://localhost:8000/api/data/companies \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "entity": "companies",
    "data": {
      "code": "DYNAMIC",
      "name": "Dynamic Company"
    }
  }'

# Search with filters
curl -X POST http://localhost:8000/api/data/companies/list \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "entity": "companies",
    "filters": [
      {"field": "code", "operator": "like", "value": "DYN"}
    ],
    "search": "Dynamic",
    "page": 1,
    "page_size": 10
  }'
```

### 4. Check Audit Logs

```bash
# List recent audit logs
curl -X POST http://localhost:8000/api/audit/list \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "page": 1,
    "page_size": 50
  }'

# Get audit statistics (admin only)
curl http://localhost:8000/api/audit/stats/summary \
  -H "Authorization: Bearer $TOKEN"
```

### 5. Manage Settings

```bash
# Get user settings
curl http://localhost:8000/api/settings/user \
  -H "Authorization: Bearer $TOKEN"

# Update theme
curl -X PUT http://localhost:8000/api/settings/user \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "theme": "dark",
    "density": "compact"
  }'

# Get tenant settings
curl http://localhost:8000/api/settings/tenant \
  -H "Authorization: Bearer $TOKEN"

# Update tenant branding (admin only)
curl -X PUT http://localhost:8000/api/settings/tenant \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_name": "My Company",
    "primary_color": "#0066cc",
    "logo_url": "https://example.com/logo.png"
  }'
```

## ğŸ“‹ API Examples

### Metadata-Driven Form Rendering

```javascript
// Frontend: Fetch metadata and render form dynamically
const metadata = await fetch('/api/metadata/entities/companies');
const { form } = metadata;

form.fields.forEach(field => {
  // Create input based on field.type
  // Apply validators from field.validators
  // Show/hide based on field.rbac_view
});
```

### Generic DataTable

```javascript
// Frontend: Universal data table component
async function loadData(entity, page, filters, sort) {
  const response = await fetch(`/api/data/${entity}/list`, {
    method: 'POST',
    body: JSON.stringify({
      entity,
      page,
      page_size: 25,
      filters,
      sort
    })
  });
  
  const { rows, total } = await response.json();
  return { rows, total };
}
```

### Audit Trail Widget

```javascript
// Show audit trail for any entity
async function showAuditTrail(entityType, entityId) {
  const response = await fetch('/api/audit/list', {
    method: 'POST',
    body: JSON.stringify({
      entity_type: entityType,
      entity_id: entityId,
      page: 1,
      page_size: 50
    })
  });
  
  const { logs } = await response.json();
  // Display logs with user, action, timestamp, changes
}
```

## ğŸ¯ Benefits

### For Developers
1. **Add New Entities in Minutes**: Just define the model and add to registry
2. **Automatic CRUD**: No need to write CRUD endpoints per entity
3. **Built-in Audit**: Every operation is logged automatically
4. **Flexible Queries**: Dynamic filters, sorting, pagination

### For Users
1. **Consistent UI**: All entities use the same patterns
2. **Audit Trail**: See who changed what and when
3. **Personalization**: Theme, language, timezone preferences
4. **Tenant Branding**: Each tenant can customize appearance

### For Admins
1. **Metadata Management**: Configure entities without code changes
2. **RBAC per Entity**: Fine-grained permissions
3. **Audit Analytics**: Track system usage and changes
4. **Feature Flags**: Enable/disable features per tenant

## ğŸ”’ Security Enhancements

### Audit Logging
- Every CUD operation logged
- User context captured
- IP and user agent tracked
- Before/after diff computed
- Tenant isolation enforced

### RBAC Integration
- Metadata stores permissions per role
- Generic CRUD respects permissions
- Tenant boundaries enforced
- Audit logs filtered by tenant

### Data Integrity
- Automatic request ID tracking
- Error messages logged
- Failed operations recorded
- Change history preserved

## ğŸ“ˆ Performance Considerations

### Indexed Queries
- Audit logs indexed on: user_id, tenant_id, action, entity_type, created_at
- Composite indexes for common queries
- Settings indexed on user_id and tenant_id

### Query Optimization
- Pagination required on list endpoints
- Configurable page sizes
- Efficient filter application
- Lazy loading of JSON fields

### Caching Strategy (Future)
- Metadata can be cached (versioned)
- User settings cached per session
- Tenant settings cached globally

## ğŸ› Known Limitations

1. **Entity Registry is Static**: Must restart to add new entities (for now)
2. **No Column-Level RBAC**: Only entity-level permissions
3. **No Computed Fields**: Metadata doesn't support calculated fields yet
4. **No Audit Retention Policy**: Logs grow indefinitely (needs cleanup job)
5. **No Bulk Audit**: Bulk operations log one entry, not per-record

## ğŸ”œ What's Next (Future Enhancements)

### Phase 3 Features
- [ ] Report runtime with template execution
- [ ] Dashboard with real-time data
- [ ] Module manager backend (hot load/unload)
- [ ] Notifications (SSE/WebSocket)
- [ ] Workflow integration
- [ ] Import/export (CSV, XLSX)

### Metadata Improvements
- [ ] Auto-generate from ORM models
- [ ] Computed fields
- [ ] Complex widgets (file upload, rich text)
- [ ] i18n labels
- [ ] Field dependencies

### CRUD Enhancements
- [ ] Column-level masking
- [ ] Optimistic locking (ETags)
- [ ] Soft deletes
- [ ] Change approval workflow

### Audit Improvements
- [ ] Retention policies per tenant
- [ ] Export to CSV/XLSX
- [ ] Sensitive data redaction
- [ ] Real-time audit stream

## ğŸ“Š Comparison: Option A vs Option B

| Feature | Option A | Option B |
|---------|----------|----------|
| Auth System | âœ… | âœ… |
| Org CRUD | âœ… Fixed endpoints | âœ… Generic endpoints |
| Metadata | âŒ | âœ… Full service |
| Generic CRUD | âŒ | âœ… Works for any entity |
| Audit | âŒ | âœ… Complete trail |
| Settings | âŒ | âœ… User & Tenant |
| RBAC | âœ… Role checks | âœ… + Entity permissions |
| Extensibility | Manual per entity | âœ… Add to registry |

## ğŸ“ Tutorial: Adding a New Entity

### 1. Define the Model

```python
# backend/app/models/product.py
from sqlalchemy import Column, String, Float, Integer
from .base import Base

class Product(Base):
    __tablename__ = "products"
    id = Column(String(36), primary_key=True)
    name = Column(String(255), nullable=False)
    price = Column(Float, nullable=False)
    stock = Column(Integer, default=0)
```

### 2. Add to Entity Registry

```python
# backend/app/routers/data.py
ENTITY_REGISTRY = {
    "companies": Company,
    "branches": Branch,
    "departments": Department,
    "users": User,
    "products": Product  # Add this
}
```

### 3. Create Migration

```bash
alembic revision --autogenerate -m "Add products table"
alembic upgrade head
```

### 4. Create Metadata

```python
# backend/app/seeds/seed_metadata.py
PRODUCT_METADATA = {
    "entity_name": "products",
    "display_name": "Products",
    "description": "Manage product catalog",
    "icon": "package",
    "table_config": json.dumps({
        "columns": [
            {"field": "name", "title": "Product Name", "sortable": True},
            {"field": "price", "title": "Price", "format": "currency"},
            {"field": "stock", "title": "Stock", "sortable": True}
        ]
    }),
    "form_config": json.dumps({
        "fields": [
            {"field": "name", "title": "Name", "type": "text", "required": True},
            {"field": "price", "title": "Price", "type": "number", "required": True},
            {"field": "stock", "title": "Stock", "type": "number", "default": 0}
        ]
    }),
    "permissions": json.dumps({
        "admin": ["create", "read", "update", "delete"],
        "user": ["read"]
    })
}
```

### 5. Seed and Use

```bash
python -m app.seeds.seed_metadata
```

Now you can use:
- `GET /api/metadata/entities/products`
- `POST /api/data/products/list`
- `POST /api/data/products` (create)
- `PUT /api/data/products/{id}` (update)
- `DELETE /api/data/products/{id}` (delete)

All with automatic audit logging! ğŸ‰

## âœ… Testing Option B

Run the updated test script:

```bash
cd backend
./test_api_option_b.sh
```

This tests:
- Metadata CRUD
- Generic data operations
- Audit logging
- Settings management
- Bulk operations

## ğŸ‰ Summary

Option B transforms your application into a **true NoCode platform**:

- âœ… **Metadata-driven**: Configure entities without code
- âœ… **Generic CRUD**: Universal data operations
- âœ… **Complete audit**: Track everything automatically
- âœ… **Personalization**: User and tenant settings
- âœ… **Extensible**: Add entities in minutes

Your platform is now ready for rapid entity creation and management! ğŸš€