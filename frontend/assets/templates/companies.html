<div class="space-y-4">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Companies</h2>
      <p class="text-gray-600 text-sm mt-1">Manage your organizations</p>
    </div>
    <button id="btn-add-company" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
      <i class="bi bi-plus-lg"></i>
      Add Company
    </button>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-lg shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
      <table id="companies-table" class="w-full">
        <thead>
          <tr class="border-b border-gray-200 bg-gray-50">
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Code</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Name</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Created</th>
            <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4" class="px-6 py-8 text-center text-gray-500">
              <i class="bi bi-inbox text-2xl block mb-2"></i>
              <p>No companies found</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="companyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Company</h3>
        <button class="text-gray-400 hover:text-gray-600" onclick="document.getElementById('companyModal').classList.add('hidden')">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 space-y-4">
        <form id="company-form">
          <input type="hidden" id="company-id">
          
          <div>
            <label for="company-code" class="block text-sm font-medium text-gray-700 mb-2">Code</label>
            <input 
              type="text" 
              id="company-code" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              required>
          </div>
          
          <div>
            <label for="company-name" class="block text-sm font-medium text-gray-700 mb-2">Name</label>
            <input 
              type="text" 
              id="company-name" 
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              required>
          </div>

          <div id="company-error" class="hidden p-3 bg-red-50 border border-red-200 text-red-700 text-sm rounded-lg"></div>
        </form>
      </div>

      <!-- Modal Footer -->
      <div class="flex items-center justify-end gap-3 p-6 border-t border-gray-200 bg-gray-50">
        <button 
          class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition" 
          onclick="document.getElementById('companyModal').classList.add('hidden')">
          Cancel
        </button>
        <button 
          id="btn-save-company" 
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { apiFetch } from '../../assets/js/api.js';

  document.addEventListener('route:loaded', async (e) => {
    if (e.detail.route === 'companies') {
      initCompanies();
    }
  });

  function initCompanies() {
    document.getElementById('btn-add-company').addEventListener('click', () => showModal());
    document.getElementById('btn-save-company').addEventListener('click', saveCompany);
    loadCompanies();
  }

  async function loadCompanies() {
    try {
      const res = await apiFetch('/org/companies');
      const data = await res.json();
      renderCompanies(data.items || []);
    } catch (err) {
      console.error('Failed to load companies:', err);
    }
  }

  function renderCompanies(companies) {
    const tbody = document.querySelector('#companies-table tbody');
    tbody.innerHTML = '';
    
    if (companies.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-6 py-8 text-center text-gray-500">
            <i class="bi bi-inbox text-2xl block mb-2"></i>
            <p>No companies found</p>
          </td>
        </tr>
      `;
      return;
    }

    companies.forEach(c => {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-gray-200 hover:bg-gray-50 transition';
      tr.innerHTML = `
        <td class="px-6 py-4 text-sm font-medium text-gray-900">${c.code}</td>
        <td class="px-6 py-4 text-sm text-gray-600">${c.name}</td>
        <td class="px-6 py-4 text-sm text-gray-600">${new Date(c.created_at).toLocaleDateString()}</td>
        <td class="px-6 py-4 text-sm space-x-2 flex">
          <button class="edit-btn px-3 py-1 text-blue-600 border border-blue-600 rounded hover:bg-blue-50 transition text-sm" data-id="${c.id}">
            <i class="bi bi-pencil-square"></i> Edit
          </button>
          <button class="delete-btn px-3 py-1 text-red-600 border border-red-600 rounded hover:bg-red-50 transition text-sm" data-id="${c.id}">
            <i class="bi bi-trash"></i> Delete
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // Attach event listeners
    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', () => editCompany(btn.dataset.id));
    });
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', () => deleteCompany(btn.dataset.id));
    });
  }

  function showModal(company = null) {
    const modal = document.getElementById('companyModal');
    document.getElementById('company-id').value = company?.id || '';
    document.getElementById('company-code').value = company?.code || '';
    document.getElementById('company-name').value = company?.name || '';
    document.getElementById('company-error').classList.add('hidden');
    document.getElementById('company-error').textContent = '';
    modal.classList.remove('hidden');
  }

  async function editCompany(id) {
    try {
      const res = await apiFetch(`/org/companies/${id}`);
      const company = await res.json();
      showModal(company);
    } catch (err) {
      alert('Failed to load company');
    }
  }

  async function deleteCompany(id) {
    if (!confirm('Are you sure you want to delete this company?')) return;
    
    try {
      const res = await apiFetch(`/org/companies/${id}`, { method: 'DELETE' });
      if (res.ok) {
        await loadCompanies();
      } else {
        const err = await res.json();
        alert(err.detail || 'Delete failed');
      }
    } catch (err) {
      alert('Delete failed');
    }
  }

  async function saveCompany() {
    const id = document.getElementById('company-id').value;
    const code = document.getElementById('company-code').value.trim();
    const name = document.getElementById('company-name').value.trim();
    const errorEl = document.getElementById('company-error');
    
    errorEl.classList.add('hidden');
    errorEl.textContent = '';
    
    if (!code || !name) {
      errorEl.textContent = 'All fields are required';
      errorEl.classList.remove('hidden');
      return;
    }
    
    const body = { code, name };
    const url = id ? `/org/companies/${id}` : '/org/companies';
    const method = id ? 'PUT' : 'POST';
    
    try {
      const res = await apiFetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      
      if (res.ok) {
        document.getElementById('companyModal').classList.add('hidden');
        await loadCompanies();
      } else {
        const err = await res.json();
        errorEl.textContent = err.detail || 'Save failed';
        errorEl.classList.remove('hidden');
      }
    } catch (err) {
      errorEl.textContent = 'Save failed';
      errorEl.classList.remove('hidden');
    }
  }
</script>