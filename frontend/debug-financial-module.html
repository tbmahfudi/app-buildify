<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Module Diagnostic</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #00ff00;
            background: #0a0a0a;
        }
        .section h2 {
            margin-top: 0;
            color: #00ffff;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .info { color: #00aaff; }
        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        button:hover {
            background: #00ffff;
        }
    </style>
</head>
<body>
    <h1>üîç Financial Module Diagnostic Tool</h1>

    <div class="section">
        <h2>Instructions</h2>
        <p>This tool checks why the financial module menu is not showing in the sidebar.</p>
        <button onclick="runDiagnostic()">Run Full Diagnostic</button>
        <button onclick="fixIssues()">Try Auto-Fix</button>
    </div>

    <div id="results"></div>

    <script type="module">
        // Import required modules
        import { apiFetch, getAuthToken } from '/assets/js/api.js';
        import { moduleLoader } from '/assets/js/core/module-system/module-loader.js';
        import { moduleRegistry } from '/assets/js/core/module-system/module-registry.js';
        import { hasPermission } from '/assets/js/rbac.js';

        window.apiFetch = apiFetch;
        window.getAuthToken = getAuthToken;
        window.moduleLoader = moduleLoader;
        window.moduleRegistry = moduleRegistry;
        window.hasPermission = hasPermission;

        window.runDiagnostic = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="section"><h2>Running diagnostics...</h2></div>';

            let html = '';

            // Step 1: Check authentication
            html += '<div class="section">';
            html += '<h2>1Ô∏è‚É£ Authentication Status</h2>';
            const token = getAuthToken();
            if (token) {
                html += '<p class="success">‚úÖ User is authenticated</p>';
                html += '<pre>' + JSON.stringify(JSON.parse(localStorage.getItem('user') || '{}'), null, 2) + '</pre>';
            } else {
                html += '<p class="error">‚ùå No auth token found</p>';
                html += '<p>Please log in first</p>';
                html += '</div>';
                results.innerHTML = html;
                return;
            }
            html += '</div>';

            // Step 2: Check backend enabled modules
            html += '<div class="section">';
            html += '<h2>2Ô∏è‚É£ Backend Module Status</h2>';
            try {
                const response = await apiFetch('/module-registry/enabled/names');
                if (response.ok) {
                    const enabledModules = await response.json();
                    html += '<p class="info">Enabled modules from backend:</p>';
                    html += '<pre>' + JSON.stringify(enabledModules, null, 2) + '</pre>';

                    if (enabledModules.includes('financial')) {
                        html += '<p class="success">‚úÖ Financial module IS ENABLED on backend</p>';
                    } else {
                        html += '<p class="error">‚ùå Financial module NOT ENABLED on backend</p>';
                        html += '<p class="warning">Solution: Enable the module via API:</p>';
                        html += '<pre>POST /api/v1/modules/enable\n';
                        html += '{\n';
                        html += '  "module_name": "financial",\n';
                        html += '  "configuration": {\n';
                        html += '    "default_currency": "USD",\n';
                        html += '    "fiscal_year_start": "01-01",\n';
                        html += '    "enable_multi_currency": false,\n';
                        html += '    "tax_rate": 0,\n';
                        html += '    "invoice_prefix": "INV"\n';
                        html += '  }\n';
                        html += '}</pre>';
                    }
                } else {
                    html += '<p class="error">‚ùå Failed to fetch enabled modules</p>';
                    html += '<p>Status: ' + response.status + '</p>';
                }
            } catch (error) {
                html += '<p class="error">‚ùå Error: ' + error.message + '</p>';
            }
            html += '</div>';

            // Step 3: Check module loader
            html += '<div class="section">';
            html += '<h2>3Ô∏è‚É£ Frontend Module Loader Status</h2>';
            const loadedModules = moduleLoader.getAllModules();
            html += '<p class="info">Loaded modules: ' + loadedModules.length + '</p>';
            html += '<pre>' + JSON.stringify(loadedModules.map(m => m.name), null, 2) + '</pre>';

            const financialModule = moduleLoader.getModule('financial');
            if (financialModule) {
                html += '<p class="success">‚úÖ Financial module IS LOADED in frontend</p>';
                html += '<pre>' + JSON.stringify({
                    name: financialModule.name,
                    displayName: financialModule.displayName,
                    version: financialModule.version
                }, null, 2) + '</pre>';
            } else {
                html += '<p class="error">‚ùå Financial module NOT LOADED in frontend</p>';

                // Check load errors
                const errors = moduleLoader.getLoadErrors();
                if (errors.has('financial')) {
                    html += '<p class="error">Load error: ' + errors.get('financial') + '</p>';
                }
            }
            html += '</div>';

            // Step 4: Check module registry
            html += '<div class="section">';
            html += '<h2>4Ô∏è‚É£ Module Registry Status</h2>';
            const registeredModules = moduleRegistry.getAllModules();
            html += '<p class="info">Registered modules: ' + registeredModules.length + '</p>';
            html += '<pre>' + JSON.stringify(registeredModules.map(m => m.name), null, 2) + '</pre>';

            const isRegistered = moduleRegistry.isModuleRegistered('financial');
            if (isRegistered) {
                html += '<p class="success">‚úÖ Financial module IS REGISTERED</p>';
            } else {
                html += '<p class="error">‚ùå Financial module NOT REGISTERED</p>';
            }

            // Check menu items
            const allMenuItems = moduleRegistry.getAllMenuItems();
            html += '<p class="info">Total menu items: ' + allMenuItems.length + '</p>';

            const financialMenuItems = allMenuItems.filter(item => item.moduleName === 'financial');
            html += '<p class="info">Financial menu items: ' + financialMenuItems.length + '</p>';
            if (financialMenuItems.length > 0) {
                html += '<pre>' + JSON.stringify(financialMenuItems, null, 2) + '</pre>';
            }
            html += '</div>';

            // Step 5: Check permissions
            html += '<div class="section">';
            html += '<h2>5Ô∏è‚É£ Permission Check</h2>';

            const permissionToCheck = 'financial:accounts:read:company';
            html += '<p class="info">Checking permission: ' + permissionToCheck + '</p>';

            try {
                const hasPerm = await hasPermission(permissionToCheck);
                if (hasPerm) {
                    html += '<p class="success">‚úÖ User HAS financial permissions</p>';
                } else {
                    html += '<p class="error">‚ùå User DOES NOT have financial permissions</p>';
                    html += '<p class="warning">Solution: Assign user to financial group/role</p>';
                }
            } catch (error) {
                html += '<p class="error">‚ùå Error checking permission: ' + error.message + '</p>';
            }

            // Try to get accessible menu items
            try {
                const accessibleMenuItems = await moduleRegistry.getAccessibleMenuItems();
                const accessibleFinancialItems = accessibleMenuItems.filter(item => item.moduleName === 'financial');

                html += '<p class="info">Accessible financial menu items: ' + accessibleFinancialItems.length + '</p>';
                if (accessibleFinancialItems.length > 0) {
                    html += '<pre>' + JSON.stringify(accessibleFinancialItems, null, 2) + '</pre>';
                } else {
                    html += '<p class="warning">‚ö†Ô∏è  No accessible financial menu items (permission filtering removed them)</p>';
                }
            } catch (error) {
                html += '<p class="error">‚ùå Error getting accessible menu: ' + error.message + '</p>';
            }
            html += '</div>';

            // Step 6: Summary
            html += '<div class="section">';
            html += '<h2>üìä Summary</h2>';
            html += '<p>Check the sections above to identify the issue:</p>';
            html += '<ul>';
            html += '<li>If backend shows module NOT ENABLED ‚Üí Enable it via API</li>';
            html += '<li>If frontend shows module NOT LOADED ‚Üí Check browser console for errors</li>';
            html += '<li>If permission check FAILS ‚Üí Assign user to financial role/group</li>';
            html += '<li>If menu items = 0 ‚Üí Module manifest might be misconfigured</li>';
            html += '</ul>';
            html += '</div>';

            results.innerHTML = html;
        };

        window.fixIssues = async function() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="section"><h2>Attempting auto-fix...</h2></div>';

            let html = '';

            // Try to reload modules
            html += '<div class="section">';
            html += '<h2>üîÑ Reloading Modules</h2>';

            try {
                await moduleLoader.loadAllModules();

                // Re-register
                for (const module of moduleLoader.getAllModules()) {
                    moduleRegistry.register(module);
                }

                html += '<p class="success">‚úÖ Modules reloaded and re-registered</p>';

                // Reload menu
                if (window.loadMenu && typeof window.loadMenu === 'function') {
                    await window.loadMenu();
                    html += '<p class="success">‚úÖ Menu reloaded</p>';
                } else {
                    html += '<p class="warning">‚ö†Ô∏è  Could not reload menu (loadMenu function not found)</p>';
                    html += '<p>Try refreshing the page</p>';
                }
            } catch (error) {
                html += '<p class="error">‚ùå Error: ' + error.message + '</p>';
            }

            html += '</div>';
            html += '<p><button onclick="window.location.reload()">Refresh Page</button></p>';
            results.innerHTML = html;
        };

        // Auto-run on load
        window.addEventListener('load', () => {
            runDiagnostic();
        });
    </script>
</body>
</html>
